<div class="vehicle-details-wrapper">
  <div class="vehicle-wrapper-header">
    <h1>פרטי רכב</h1>
    <div style="display: flex; gap: 10px">
      <button
        *ngIf="!isEditMode && vehicle?.status !== 'archived'"
        class="edit-button"
        (click)="enterEditMode()"
      >
        <mat-icon>edit</mat-icon> ערוך
      </button>
      <button *ngIf="isEditMode" class="save-button" (click)="saveChanges()">
        <mat-icon>save</mat-icon> שמור
      </button>
      <button *ngIf="isEditMode" class="cancel-button" (click)="cancelEdit()">
        <mat-icon>close</mat-icon> בטל
      </button>
      <button class="back-btn" (click)="goBack()">חזור ←</button>
    </div>
  </div>
  <br />

  <div class="vehicle-details-content">
    <p-card
      *ngIf="vehicle"
      class="vehicle-details-card"
      [ngClass]="getCardClass(vehicle.status)"
    >
      <div class="vehicle-horizontal-content">
        <div class="right-side">
          <div class="usage-line">
            <div
              class="usage-indicator"
              [style.background-color]="getUsageBarColor(vehicle.plate_number)"
            ></div>
            <span
              class="usage-number"
              *ngIf="getVehicleUsageCount(vehicle.plate_number) > 0"
            >
              {{ getVehicleUsageCount(vehicle.plate_number) }} נסיעות קיימות
              לרכב זה
            </span>
          </div>
          <div class="vehicle-image-container">
            <img
              *ngIf="vehicle.image_url"
              [src]="vehicle.image_url"
              alt="תמונה של הרכב"
              class="vehicle-details-img"
            />
            <div *ngIf="!vehicle.image_url" class="no-image-placeholder">
              <mat-icon>directions_car</mat-icon>
              <p>אין תמונה</p>
            </div>
            <div *ngIf="isEditMode" class="image-edit-section">
              <label><strong>URL תמונה:</strong></label>
              <input
                type="text"
                [(ngModel)]="vehicle.image_url"
                class="edit-input"
                placeholder="הכנס כתובת URL של התמונה"
              />
            </div>
          </div>
        </div>

        <div class="vehicle-details-info">
          <h2>רכב: {{ vehicle.plate_number }}</h2>

          <div
            *ngIf="isLeaseExpired(vehicle.lease_expiry)"
            class="lease-expired-warning"
          >
            <mat-icon color="warn">warning</mat-icon> חוזה ההשכרה פג
          </div>

          <p><strong>דגם:</strong> {{ vehicle.vehicle_model }}</p>
          <p><strong>סטטוס:</strong> {{ translateStatus(vehicle.status) }}</p>
          <p><strong>סוג רכב:</strong> {{ translateType(vehicle.type) }}</p>
          <p>
            <strong>סוג דלק:</strong> {{ translateFuelType(vehicle.fuel_type) }}
          </p>
          <p>
            <strong>שימוש אחרון:</strong>
            {{ formatLastUsedAt(vehicle.last_used_at) }}
          </p>
          <p *ngIf="!isEditMode">
            <strong>מחלקה:</strong> {{ departmentName || "לא משוייך למחלקה" }}
          </p>
          <div *ngIf="isEditMode" class="edit-field">
            <label><strong>מחלקה:</strong></label>
            <select [(ngModel)]="vehicle.department_id" class="edit-select">
              <option value="">לא משוייך למחלקה</option>
              <option *ngFor="let dept of filteredDepartments" [value]="dept.id">
                {{ dept.name }}
              </option>
            </select>
          </div>
          <p *ngIf="vehicle.reason_for_4x4">
            <strong>סיבת 4x4:</strong> {{ vehicle.reason_for_4x4 }}
          </p>

          <p *ngIf="vehicle.status === 'frozen' && vehicle.freeze_reason">
            <strong>סיבת הקפאה:</strong>
            {{ translateFreezeReason(vehicle.freeze_reason) }}
          </p>

          <p
            *ngIf="!isEditMode"
            style="
              display: flex;
              align-items: center;
              gap: 1rem;
              flex-wrap: wrap;
            "
          >
            <strong>קילומטראז':</strong>
            {{ vehicle.mileage | number }} ק"מ
          </p>
          <div *ngIf="isEditMode" class="edit-field">
            <label><strong>קילומטראז':</strong></label>
            <input
              type="number"
              [(ngModel)]="vehicle.mileage"
              [min]="0"
              class="edit-input"
            />
          </div>

          <p *ngIf="vehicle.mileage_last_updated">
            <strong>עודכן לאחרונה:</strong>
            {{ vehicle.mileage_last_updated | date : "dd/MM/yyyy" }}
          </p>

          <p>
            <strong>מספר נסיעות לחודש זה:</strong> {{ currentVehicleRideCount }}
          </p>
        


          <p>
            <strong>תוקף חוזה השכרה:</strong>
            {{
              vehicle.lease_expiry
                ? (vehicle.lease_expiry | date : "dd/MM/yyyy")
                : "לא סופק"
            }}
          </p>

          <div
            *ngIf="!isEditMode"
            style="
              display: flex;
              align-items: center;
              gap: 15px;
              flex-wrap: wrap;
              margin-top: 20px;
            "
          >
            <button
              class="unfreeze-button button-spacing"
              (click)="confirmUnfreeze()"
              *ngIf="vehicle.status === 'frozen' && !isLeaseExpired(vehicle.lease_expiry)"
            >
              שחרור מהקפאה
            </button>

            <div
              *ngIf="
                vehicle.status === 'in-use' || vehicle.status === 'available'
              "
            >
              <button
                class="freeze-button button-spacing"
                (click)="showFreezeReasonField()"
              >
                הקפא רכב
              </button>

              <div
                *ngIf="isFreezeReasonFieldVisible"
                class="freeze-reason-container"
              >
                <select
                  [(ngModel)]="freezeReason"
                  class="freeze-reason-dropdown"
                >
                  <option value="" disabled selected>בחר סיבת הקפאה</option>
                  <option value="maintenance">תחזוקה</option>
                  <option value="accident">תאונה</option>
                  <option value="personal">אישי</option>
                </select>

                <div
                  *ngIf="freezeReason === 'personal'"
                  class="personal-reason-box"
                >
                  <label class="personal-reason-label"
                    >פרטי הקפאה אישיים:</label
                  >
                  <textarea
                    [(ngModel)]="freezeDetails"
                    rows="2"
                    class="personal-textarea"
                  ></textarea>
                </div>

                <button
                  class="confirm-freeze-button button-spacing"
                  (click)="confirmFreeze()"
                >
                  אישור הקפאה
                </button>
              </div>
            </div>
            <button
              class="freeze-button button-spacing"
              dir="rtl"
              (click)="confirmDeleteVehicle(vehicle)"
            >
              {{
                vehicle.status === "in-use"
                  ? "לא ניתן למחוק רכב בשימוש"
                  : "מחק רכב"
              }}
            </button>
            <button
              *ngIf="
                vehicle.status === 'frozen' &&
                isLeaseExpired(vehicle.lease_expiry) &&
                vehicle.canDelete
              "
              class="freeze-button button-spacing"
              (click)="confirmArchive(vehicle)"
              title="הרכב מוקפא – ניתן לארכב"
            >
              ארכוב רכב
            </button>

            <button
              class="freeze-button button-spacing"
              (click)="navigateToTimeline()"
            >
              צפה בלוח הזמנים
            </button>
          </div>
        </div>
      </div>
    </p-card>
  </div>
</div>
