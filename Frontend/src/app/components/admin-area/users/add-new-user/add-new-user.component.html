<div class="wrapper">
  <div class="page-header">
    <h2>הוספת משתמש חדש</h2>
  </div>

  <div class="form-container">
    <form [formGroup]="addUserForm" (ngSubmit)="submit()">
      <input type="text" name="prevent_autofill" style="display: none" />
      <input type="password" name="password_fake" style="display: none" />
      <div class="form-section">
        <div class="form-group">
          <label>שם פרטי</label>
          <input
            type="text"
            formControlName="first_name"
            (keypress)="preventSpaces($event)"
          />
          <div class="validation-wrapper">
            <small
              *ngIf="
                (addUserForm.get('first_name')?.touched ||
                  addUserForm.get('first_name')?.dirty) &&
                addUserForm.get('first_name')?.hasError('required')
              "
              class="error"
            >
              חובה להזין שם פרטי
            </small>
            <small
              *ngIf="
                (addUserForm.get('first_name')?.touched ||
                  addUserForm.get('first_name')?.dirty) &&
                addUserForm.get('first_name')?.hasError('minlength')
              "
              class="error"
            >
              לפחות 2 אותיות
            </small>
            <small
              *ngIf="
                (addUserForm.get('first_name')?.touched ||
                  addUserForm.get('first_name')?.dirty) &&
                addUserForm.get('first_name')?.hasError('pattern')
              "
              class="error"
            >
              רק אותיות בעברית או באנגלית (ללא רווחים)
            </small>
            <small
              *ngIf="
                (addUserForm.get('first_name')?.touched ||
                  addUserForm.get('first_name')?.dirty) &&
                addUserForm.get('first_name')?.hasError('mixedLanguage')
              "
              class="error"
            >
              לא ניתן לערבב עברית ואנגלית
            </small>
          </div>
        </div>

        <div class="form-group">
          <label>שם משפחה</label>
          <input
            type="text"
            formControlName="last_name"
            (keypress)="preventSpaces($event)"
          />
          <div class="validation-wrapper">
            <small
              *ngIf="
                (addUserForm.get('last_name')?.touched ||
                  addUserForm.get('last_name')?.dirty) &&
                addUserForm.get('last_name')?.hasError('required')
              "
              class="error"
            >
              חובה להזין שם משפחה
            </small>
            <small
              *ngIf="
                (addUserForm.get('last_name')?.touched ||
                  addUserForm.get('last_name')?.dirty) &&
                addUserForm.get('last_name')?.hasError('minlength')
              "
              class="error"
            >
              לפחות 2 אותיות
            </small>
            <small
              *ngIf="
                (addUserForm.get('last_name')?.touched ||
                  addUserForm.get('last_name')?.dirty) &&
                addUserForm.get('last_name')?.hasError('pattern')
              "
              class="error"
            >
              רק אותיות בעברית או באנגלית (ללא רווחים)
            </small>
            <small
              *ngIf="
                (addUserForm.get('last_name')?.touched ||
                  addUserForm.get('last_name')?.dirty) &&
                addUserForm.get('last_name')?.hasError('mixedLanguage')
              "
              class="error"
            >
              לא ניתן לערבב עברית ואנגלית
            </small>
          </div>
        </div>

        <div class="form-group">
          <label>שם משתמש</label>
          <input
            type="text"
            formControlName="username"
            (keypress)="preventSpaces($event)"
          />
          <div class="validation-wrapper">
            <small
              *ngIf="
                (addUserForm.get('username')?.touched ||
                  addUserForm.get('username')?.dirty) &&
                addUserForm.get('username')?.hasError('required')
              "
              class="error"
            >
              חובה להזין שם משתמש
            </small>
            <small
              *ngIf="
                (addUserForm.get('username')?.touched ||
                  addUserForm.get('username')?.dirty) &&
                addUserForm.get('username')?.hasError('minlength')
              "
              class="error"
            >
              לפחות 3 תווים
            </small>
            <small
              *ngIf="
                (addUserForm.get('username')?.touched ||
                  addUserForm.get('username')?.dirty) &&
                addUserForm.get('username')?.hasError('pattern')
              "
              class="error"
            >
              רק אותיות בעברית או באנגלית (ללא רווחים)
            </small>
            <small
              *ngIf="
                (addUserForm.get('username')?.touched ||
                  addUserForm.get('username')?.dirty) &&
                addUserForm.get('username')?.hasError('mixedLanguage')
              "
              class="error"
            >
              לא ניתן לערבב עברית ואנגלית
            </small>
            <small
              *ngIf="
                (addUserForm.get('username')?.touched ||
                  addUserForm.get('username')?.dirty) &&
                addUserForm.get('username')?.hasError('minLetters')
              "
              class="error"
            >
              חייב להכיל לפחות 2 אותיות
            </small>
          </div>
        </div>
      </div>

      <div class="form-section">
        <div class="form-group">
          <label>אימייל</label>
          <input
            type="email"
            formControlName="email"
            (keypress)="preventSpaces($event)"
          />
          <div class="validation-wrapper">
            <small
              *ngIf="
                (addUserForm.get('email')?.touched ||
                  addUserForm.get('email')?.dirty) &&
                addUserForm.get('email')?.hasError('required')
              "
              class="error"
            >
              חובה להזין אימייל
            </small>
            <small
              *ngIf="
                (addUserForm.get('email')?.touched ||
                  addUserForm.get('email')?.dirty) &&
                addUserForm.get('email')?.hasError('invalidEmail')
              "
              class="error"
            >
              אימייל לא תקין
            </small>
          </div>
        </div>

        <div class="form-group">
          <label>טלפון</label>
          <input
            type="tel"
            formControlName="phone"
            (keypress)="preventSpaces($event)"
            autocomplete="none"
          />
          <small *ngIf="getPhoneErrors()" class="error">
            {{ getPhoneErrors() }}
          </small>
        </div>
      </div>

      <div class="form-section">
        <div class="form-group">
          <label>תפקיד</label>
          <select formControlName="role">
            <option value="" disabled selected>בחר תפקיד</option>
            <option *ngFor="let r of roles" [value]="r.key">
              {{ r.label }}
            </option>
          </select>
          <small
            *ngIf="
              addUserForm.get('role')?.touched &&
              addUserForm.get('role')?.invalid
            "
            class="error"
          >
            חובה לבחור תפקיד
          </small>
        </div>

        <div class="form-group" *ngIf="shouldShowSupervisedDepartment()">
          <label style="margin-top: 14px">מחלקה (אופציונלי)</label>
          <select formControlName="supervised_department_id">
            <option value="">ללא מחלקה</option>
            <option *ngFor="let d of departments" [value]="d.id">
              {{ d.name }}
              <span *ngIf="d.supervisor_id"> (תפוס)</span>
            </option>
          </select>

          <small
            *ngIf="
              addUserForm
                .get('supervised_department_id')
                ?.hasError('departmentOccupied')
            "
            class="error"
            style="display: block; margin-top: 5px"
          >
            {{ getOccupiedDepartmentError() }}
          </small>
        </div>
      </div>

      <div class="form-section">
        <div class="form-group">
          <label>סיסמה</label>
          <div class="password-container">
            <input
              [type]="showPassword ? 'text' : 'password'"
              formControlName="password"
              class="password-input"
              autocomplete="new-password"
              (keypress)="preventSpaces($event)"
            />
            <mat-icon class="show-password" (click)="togglePassword()">
              {{ showPassword ? "visibility" : "visibility_off" }}
            </mat-icon>
          </div>
          <small *ngIf="getPasswordErrors()" class="error">
            {{ getPasswordErrors() }}
          </small>
        </div>
      </div>

      <div class="form-section">
        <div class="form-group">
          <label for="has_government_license"
            >האם המשתמש בעל רישיון נהיגה ממשלתי?</label
          >
          <label class="switch">
            <input
              type="checkbox"
              id="has_government_license"
              formControlName="has_government_license"
            />
            <span class="slider"></span>
          </label>
        </div>

        <h4 id="warning" *ngIf="!checkIfHasGovernmentlicense()">
          <i class="pi pi-exclamation-triangle"></i>
          המשתמש לא יוכל להזמין נסיעות
          <i class="pi pi-exclamation-triangle"></i>
        </h4>

        <div class="form-group" *ngIf="checkIfHasGovernmentlicense()">
          <label style="margin-top: 20px" for="license_expiry_date"
            >תוקף רישיון</label
          >
          <input
            type="date"
            id="license_expiry_date"
            formControlName="license_expiry_date"
          />
          <small
            *ngIf="
              addUserForm.get('license_expiry_date')?.touched &&
              addUserForm.get('license_expiry_date')?.hasError('dateRange')
            "
            class="error"
          >
            התאריך חייב להיות בעתיד
          </small>
        </div>

        <div class="form-group" *ngIf="checkIfHasGovernmentlicense()">
          <label style="margin-top: 20px"
            >העלה תמונת/קובץ רישיון (אופציונלי)</label
          >
          <div class="custom-file-upload">
            <input
              type="file"
              id="licenseUpload"
              (change)="onFileSelected($event)"
              #fileInput
            />

            <div class="file-upload-area" (click)="fileInput.click()">
              <span class="file-text" *ngIf="selectedFileName">{{
                selectedFileName
              }}</span>
              <span class="file-text" *ngIf="!selectedFileName"
                >לא נבחר קובץ</span
              >
              <button type="button" class="choose-file-btn">בחר קובץ</button>
            </div>
          </div>
          <small class="info">ניתן לשנות את קובץ הרישיון</small>
        </div>
      </div>

      <div class="form-group center">
        <button type="submit" class="submit-btn">הוסף משתמש</button>
      </div>
    </form>
  </div>
</div>
