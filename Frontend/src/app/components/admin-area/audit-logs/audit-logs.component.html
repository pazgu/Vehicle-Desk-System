<div class="page-wrapper">
  <div class="page-container">
    <div class="audit-wrapper">
      <h1>צפייה ביומני ביקורת</h1>

      <div class="filter-section">
        <button class="filter-button" (click)="showFilters = !showFilters">
          {{ showFilters ? 'הסתר חיפוש' : 'הצג חיפוש' }}
        </button>
      </div>

      <div *ngIf="showFilters" class="search-container">
        <input type="text" class="audit-search-input" placeholder="חיפוש לפי סוג ישות, מזהה ישות או מי שינה"
          [(ngModel)]="searchTerm" (input)="filterLogs()" />
      </div>

      <div class="status-indicators">
        <p style="margin-bottom: 0.75rem; font-weight: 600;">מקרא צבעים</p>
        <div class="status-box">
          <div class="status-item">
            <span class="status-indicator approved"></span> מאושר
          </div>
          <div class="status-item">
            <span class="status-indicator frozen"></span> מוקפא
          </div>
          <div class="status-item">
            <span class="status-indicator pending"></span> בהמתנה
          </div>
          <div class="status-item">
            <span class="status-indicator rejected"></span> נדחה
          </div>
          <div class="status-item">
            <span class="status-indicator emergency"></span> אירוע חירום
        </div>
        </div>
        </div>

      <div class="table-container" *ngIf="!selectedLog">
        <table class="audit-table">
          <thead class="audit-thead">
            <tr>
              <th class="audit-th">סוג פעולה</th>
              <th class="audit-th">סוג ישות</th>
              <th class="audit-th">שם מלא</th>
              <th class="audit-th">תאריך יצירה</th>
            </tr>
          </thead>
          <tbody class="audit-tbody">
            <tr *ngFor="let log of pagedLogs" class="audit-tr"
              [ngClass]="{
                'emergency-row': log.action === 'UPDATE' && log.entity_type === 'Ride' && (log.change_data?.new?.emergency_event === true || log.change_data?.new?.emergency_event === 'true'),
                'frozen-vehicle-row': log.entity_type === 'Vehicle' && log.change_data?.new?.status === 'frozen',
                'pending-row': log.entity_type === 'Ride' && (
                  (log.action === 'UPDATE' && log.change_data?.new?.status === 'pending') ||
                  (log.action === 'INSERT' && log.change_data?.status === 'pending')
                ),
                'approved-row': 
                  (log.entity_type === 'Ride' && log.change_data?.new?.status === 'approved') ||
                  (log.entity_type === 'Vehicle' && log.change_data?.new?.status === 'available') ||
                  (log.entity_type === 'User' && log.action === 'UPDATE' && log.change_data?.old?.role !== 'admin' && log.change_data?.new?.role === 'admin'),
                'rejected-row': log.entity_type === 'Ride' && log.change_data?.new?.status === 'rejected',
                'user-insert-row': log.action === 'INSERT' && log.entity_type === 'User'
              }"
              (click)="showDetails(log)"
            >
              <td class="audit-td">{{ log.action }}</td>
              <td class="audit-td">{{ log.entity_type }}</td>
              <td class="audit-td">{{ log.full_name }}</td>
              <td class="audit-td">{{ log.created_at | date:'dd/MM/yyyy HH:mm' }}</td>
            </tr>
          </tbody>
        </table>
        <!-- Pagination Controls -->

     <div class="pagination-controls" dir="rtl" style="text-align: center; margin-top: 1.5rem;">
  <button (click)="prevPage()" [disabled]="currentPage === 1">▶</button>
  <span>עמוד {{ currentPage }} מתוך {{ totalPages }}</span>
  <button (click)="nextPage()" [disabled]="currentPage === totalPages">◀</button>
</div>
      </div>

      <div *ngIf="filteredLogs?.length === 0 && !selectedLog" class="empty-state">
        לא נמצאו רשומות ביקורת
      </div>

      <div *ngIf="selectedLog" class="log-details-card">
        <h2>פרטי יומן ביקורת</h2>

        <!-- Main Info Section -->
        <div class="main-info">
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">מזהה יומן</div>
              <div class="info-value">{{ selectedLog.id }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">סוג פעולה</div>
              <div class="info-value">{{ selectedLog.action }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">סוג ישות</div>
              <div class="info-value">{{ selectedLog.entity_type }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">מזהה ישות</div>
              <div class="info-value">{{ selectedLog.entity_id }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">שם מלא</div>
              <div class="info-value">{{ selectedLog.full_name }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">תאריך יצירה</div>
              <div class="info-value">{{ selectedLog.created_at | date:'dd/MM/yyyy HH:mm:ss' }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">שונה על ידי</div>
              <div class="info-value">{{ selectedLog.changed_by }}</div>
            </div>
          </div>
        </div>

        <!-- Change Data Section -->
        <div class="change-section">
          <h3>נתוני שינוי</h3>

          <!-- INSERT Action -->
          <div *ngIf="selectedLog.action === 'INSERT'">
            <div class="data-card insert-data">
              <h4>נתונים חדשים</h4>

              <!-- User Entity -->
              <div *ngIf="selectedLog.entity_type === 'User'" class="entity-fields">
                <div class="field-row">
                  <div class="field-label">תפקיד</div>
                  <div class="field-value">{{ selectedLog.change_data.role }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">אימייל</div>
                  <div class="field-value">{{ selectedLog.change_data.email }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">שם משתמש</div>
                  <div class="field-value">{{ selectedLog.change_data.username }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">שם פרטי</div>
                  <div class="field-value">{{ selectedLog.change_data.first_name }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">שם משפחה</div>
                  <div class="field-value">{{ selectedLog.change_data.last_name }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מזהה עובד</div>
                  <div class="field-value">{{ selectedLog.change_data.employee_id }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מזהה מחלקה</div>
                  <div class="field-value">{{ selectedLog.change_data.department_id }}</div>
                </div>
              </div>

              <!-- Ride Entity -->
              <div *ngIf="selectedLog.entity_type === 'Ride'" class="entity-fields">
                <div class="field-row">
                  <div class="field-label">מזהה נסיעה</div>
                  <div class="field-value">{{ selectedLog.change_data.id }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">סטטוס</div>
                  <div class="field-value">{{ selectedLog.change_data.status }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">סוג נסיעה</div>
                  <div class="field-value">{{ selectedLog.change_data.ride_type }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מיקום התחלה</div>
                  <div class="field-value">{{ selectedLog.change_data.start_location }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">יעד</div>
                  <div class="field-value">{{ selectedLog.change_data.destination }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">תאריך התחלה</div>
                  <div class="field-value">{{ selectedLog.change_data.start_datetime | date:'dd/MM/yyyy HH:mm' }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">תאריך סיום</div>
                  <div class="field-value">{{ selectedLog.change_data.end_datetime | date:'dd/MM/yyyy HH:mm' }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מזהה משתמש</div>
                  <div class="field-value">{{ selectedLog.change_data.user_id }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מזהה רכב</div>
                  <div class="field-value">{{ selectedLog.change_data.vehicle_id }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">עצירה</div>
                  <div class="field-value">{{ selectedLog.change_data.stop }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מרחק משוער (ק"מ)</div>
                  <div class="field-value">{{ selectedLog.change_data.estimated_distance_km }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מרחק בפועל (ק"מ)</div>
                  <div class="field-value">{{ selectedLog.change_data.actual_distance_km }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">אירוע חירום</div>
                  <div class="field-value">{{ selectedLog.change_data.emergency_event }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">עבר בדיקת רישיון</div>
                  <div class="field-value"
                    [ngClass]="selectedLog.change_data.license_check_passed ? 'boolean-yes' : 'boolean-no'">
                    {{ selectedLog.change_data.license_check_passed ? 'כן' : 'לא' }}
                  </div>
                </div>
                <div class="field-row">
                  <div class="field-label">ארכיון</div>
                  <div class="field-value" [ngClass]="selectedLog.change_data.isArchive ? 'boolean-yes' : 'boolean-no'">
                    {{ selectedLog.change_data.isArchive ? 'כן' : 'לא' }}
                  </div>
                </div>
                <div *ngIf="selectedLog.change_data.override_user_id" class="field-row">
                  <div class="field-label">מזהה משתמש עוקף</div>
                  <div class="field-value">{{ selectedLog.change_data.override_user_id }}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- UPDATE Action -->
          <div *ngIf="selectedLog.action === 'UPDATE'">
            <!-- Old Data -->
            <div class="data-card old-data">
              <h4>נתונים ישנים</h4>

              <div *ngIf="selectedLog.entity_type === 'User'" class="entity-fields">
                <div class="field-row">
                  <div class="field-label">תפקיד</div>
                  <div class="field-value">{{ selectedLog.change_data.old.role }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">אימייל</div>
                  <div class="field-value">{{ selectedLog.change_data.old.email }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">שם משתמש</div>
                  <div class="field-value">{{ selectedLog.change_data.old.username }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">שם פרטי</div>
                  <div class="field-value">{{ selectedLog.change_data.old.first_name }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">שם משפחה</div>
                  <div class="field-value">{{ selectedLog.change_data.old.last_name }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מזהה עובד</div>
                  <div class="field-value">{{ selectedLog.change_data.old.employee_id }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מזהה מחלקה</div>
                  <div class="field-value">{{ selectedLog.change_data.old.department_id }}</div>
                </div>
              </div>

              <div *ngIf="selectedLog.entity_type === 'Ride'" class="entity-fields">
                <div class="field-row">
                  <div class="field-label">מזהה נסיעה</div>
                  <div class="field-value">{{ selectedLog.change_data.old.id }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">עצירה</div>
                  <div class="field-value">{{ selectedLog.change_data.old.stop }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">סטטוס</div>
                  <div class="field-value">{{ selectedLog.change_data.old.status }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">סוג נסיעה</div>
                  <div class="field-value">{{ selectedLog.change_data.old.ride_type }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מיקום התחלה</div>
                  <div class="field-value">{{ selectedLog.change_data.old.start_location }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">יעד</div>
                  <div class="field-value">{{ selectedLog.change_data.old.destination }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">תאריך התחלה</div>
                  <div class="field-value">{{ selectedLog.change_data.old.start_datetime | date:'dd/MM/yyyy HH:mm' }}
                  </div>
                </div>
                <div class="field-row">
                  <div class="field-label">תאריך סיום</div>
                  <div class="field-value">{{ selectedLog.change_data.old.end_datetime | date:'dd/MM/yyyy HH:mm' }}
                  </div>
                </div>
                <div class="field-row">
                  <div class="field-label">מזהה משתמש</div>
                  <div class="field-value">{{ selectedLog.change_data.old.user_id }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מזהה רכב</div>
                  <div class="field-value">{{ selectedLog.change_data.old.vehicle_id }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מרחק משוער (ק"מ)</div>
                  <div class="field-value">{{ selectedLog.change_data.old.estimated_distance_km }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מרחק בפועל (ק"מ)</div>
                  <div class="field-value">{{ selectedLog.change_data.old.actual_distance_km }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">אירוע חירום</div>
                  <div class="field-value">{{ selectedLog.change_data.old.emergency_event }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">עבר בדיקת רישיון</div>
                  <div class="field-value"
                    [ngClass]="selectedLog.change_data.old.license_check_passed ? 'boolean-yes' : 'boolean-no'">
                    {{ selectedLog.change_data.old.license_check_passed ? 'כן' : 'לא' }}
                  </div>
                </div>
                <div class="field-row">
                  <div class="field-label">מזהה משתמש עוקף</div>
                  <div class="field-value">{{ selectedLog.change_data.old.override_user_id }}</div>
                </div>
              </div>

              <!-- Old Data for Vehicle -->
              <div *ngIf="selectedLog.entity_type === 'Vehicle'" class="entity-fields">
                <div class="field-row">
                  <div class="field-label">מזהה רכב</div>
                  <div class="field-value">{{ selectedLog.change_data.old.id }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">סוג רכב</div>
                  <div class="field-value">{{ selectedLog.change_data.old.type }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">סטטוס</div>
                  <div class="field-value">{{ selectedLog.change_data.old.status }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">סוג דלק</div>
                  <div class="field-value">{{ selectedLog.change_data.old.fuel_type }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מספר רישוי</div>
                  <div class="field-value">{{ selectedLog.change_data.old.plate_number }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מודל רכב</div>
                  <div class="field-value">{{ selectedLog.change_data.old.vehicle_model }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מיקום נוכחי</div>
                  <div class="field-value">{{ selectedLog.change_data.old.current_location }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">ק"מ נוכחי</div>
                  <div class="field-value">{{ selectedLog.change_data.old.odometer_reading }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">סיבת הקפאה</div>
                  <div class="field-value">{{ selectedLog.change_data.old.freeze_reason }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">פרטי הקפאה</div>
                  <div class="field-value">{{ selectedLog.change_data.old.freeze_details }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">תמונה</div>
                  <div class="field-value">
                    <img [src]="selectedLog.change_data.old.image_url" alt="תמונת רכב"
                      style="max-width: 120px; max-height: 80px;">
                  </div>
                </div>
              </div>
            </div>

            <!-- New Data -->
            <div class="data-card new-data">
              <h4>נתונים חדשים</h4>

              <div *ngIf="selectedLog.entity_type === 'User'" class="entity-fields">
                <div class="field-row">
                  <div class="field-label">תפקיד</div>
                  <div class="field-value">{{ selectedLog.change_data.new.role }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">אימייל</div>
                  <div class="field-value">{{ selectedLog.change_data.new.email }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">שם משתמש</div>
                  <div class="field-value">{{ selectedLog.change_data.new.username }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">שם פרטי</div>
                  <div class="field-value">{{ selectedLog.change_data.new.first_name }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">שם משפחה</div>
                  <div class="field-value">{{ selectedLog.change_data.new.last_name }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מזהה עובד</div>
                  <div class="field-value">{{ selectedLog.change_data.new.employee_id }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מזהה מחלקה</div>
                  <div class="field-value">{{ selectedLog.change_data.new.department_id }}</div>
                </div>
              </div>

              <div *ngIf="selectedLog.entity_type === 'Ride'" class="entity-fields">
                <div class="field-row">
                  <div class="field-label">מזהה נסיעה</div>
                  <div class="field-value">{{ selectedLog.change_data.new.id }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">עצירה</div>
                  <div class="field-value">{{ selectedLog.change_data.new.stop }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">סטטוס</div>
                  <div class="field-value">{{ selectedLog.change_data.new.status }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">סוג נסיעה</div>
                  <div class="field-value">{{ selectedLog.change_data.new.ride_type }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מיקום התחלה</div>
                  <div class="field-value">{{ selectedLog.change_data.new.start_location }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">יעד</div>
                  <div class="field-value">{{ selectedLog.change_data.new.destination }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">תאריך התחלה</div>
                  <div class="field-value">{{ selectedLog.change_data.new.start_datetime | date:'dd/MM/yyyy HH:mm' }}
                  </div>
                </div>
                <div class="field-row">
                  <div class="field-label">תאריך סיום</div>
                  <div class="field-value">{{ selectedLog.change_data.new.end_datetime | date:'dd/MM/yyyy HH:mm' }}
                  </div>
                </div>
                <div class="field-row">
                  <div class="field-label">מזהה משתמש</div>
                  <div class="field-value">{{ selectedLog.change_data.new.user_id }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מזהה רכב</div>
                  <div class="field-value">{{ selectedLog.change_data.new.vehicle_id }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מרחק משוער (ק"מ)</div>
                  <div class="field-value">{{ selectedLog.change_data.new.estimated_distance_km }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מרחק בפועל (ק"מ)</div>
                  <div class="field-value">{{ selectedLog.change_data.new.actual_distance_km }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">אירוע חירום</div>
                  <div class="field-value">{{ selectedLog.change_data.new.emergency_event }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">עבר בדיקת רישיון</div>
                  <div class="field-value"
                    [ngClass]="selectedLog.change_data.new.license_check_passed ? 'boolean-yes' : 'boolean-no'">
                    {{ selectedLog.change_data.new.license_check_passed ? 'כן' : 'לא' }}
                  </div>
                </div>
                <div class="field-row">
                  <div class="field-label">מזהה משתמש עוקף</div>
                  <div class="field-value">{{ selectedLog.change_data.new.override_user_id }}</div>
                </div>
              </div>

              <!-- New Data for Vehicle -->
              <div *ngIf="selectedLog.entity_type === 'Vehicle'" class="entity-fields">
                <div class="field-row">
                  <div class="field-label">מזהה רכב</div>
                  <div class="field-value">{{ selectedLog.change_data.new.id }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">סוג רכב</div>
                  <div class="field-value">{{ selectedLog.change_data.new.type }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">סטטוס</div>
                  <div class="field-value">{{ selectedLog.change_data.new.status }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">סוג דלק</div>
                  <div class="field-value">{{ selectedLog.change_data.new.fuel_type }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מספר רישוי</div>
                  <div class="field-value">{{ selectedLog.change_data.new.plate_number }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מודל רכב</div>
                  <div class="field-value">{{ selectedLog.change_data.new.vehicle_model }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">מיקום נוכחי</div>
                  <div class="field-value">{{ selectedLog.change_data.new.current_location }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">ק"מ נוכחי</div>
                  <div class="field-value">{{ selectedLog.change_data.new.odometer_reading }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">סיבת הקפאה</div>
                  <div class="field-value">{{ selectedLog.change_data.new.freeze_reason }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">פרטי הקפאה</div>
                  <div class="field-value">{{ selectedLog.change_data.new.freeze_details }}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">תמונה</div>
                  <div class="field-value">
                    <img [src]="selectedLog.change_data.new.image_url" alt="תמונת רכב"
                      style="max-width: 120px; max-height: 80px;">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Other Actions (DELETE, etc.) -->
          <div *ngIf="selectedLog.action !== 'INSERT' && selectedLog.action !== 'UPDATE'" class="data-card">
            <h4>נתוני שינוי גולמיים</h4>
            <div class="json-container">
              <pre>{{ selectedLog.change_data | json }}</pre>
            </div>
          </div>
        </div>

        <button class="close-details-button" (click)="closeDetails()">סגור</button>
      </div>
    </div>
  </div>
</div>