<div class="overlay">
  <div class="modal">
    <div class="header-row">
      <h2 class="page-title">הזמנה חדשה</h2>
      <div *ngIf="step === 2" class="step-header">
        <button type="button" class="back-btn" (click)="goBackToStep1()">
          ← חזור
        </button>
      </div>
    </div>
    <hr />

    <form [formGroup]="rideForm">
      <div *ngIf="step === 1">
        <h3 class="ride-question">האם הנסיעה עבורך או עבור עובד אחר?</h3>
        <div class="form-field-group">
          <label>
            <input type="radio" formControlName="target_type" value="self" />
            לעצמי
          </label>
          <label>
            <input type="radio" formControlName="target_type" value="other" />
            לעובד אחר מהמחלקה
          </label>
        </div>

        <div class="form-field-group" *ngIf="rideForm.get('target_type')?.value === 'other'">
          <label>בחר עובד</label>
          <select formControlName="target_employee_id">
            <option value="">בחר עובד</option>
            <option *ngFor="let emp of departmentEmployees" [value]="emp.id">
              {{ emp.full_name }}
            </option>
          </select>
        </div>
        <div class="button-container">
          <button class="submit-btn" (click)="handleStep1Next()">הבא</button>
          <small *ngIf="showStep1Error" class="error-text">יש לבחור עובד מהמחלקה כדי להמשיך</small>
        </div>
      </div>

      <div *ngIf="step === 2">
        <div class="request-backdrop" *ngIf="step === 2 && disableRequest"></div>

        <div class="disable-request" *ngIf="disableRequest">
          <p>העובד אינו מחזיק ברישיון ממשלתי תקף ולא ניתן להזמין עבורו נסיעה</p>
          <small>לעדכון פרטי רישיון יש ליצור קשר עם המנהל</small>
        </div>

        <div class="form-content">


          <!-- Row 1: ride_period + ride_date + ride_type -->
          <div class="form-row">
            <div class="form-field-group">
              <label>מספר ימי נסיעה (יום / יומיים)</label>
              <select formControlName="ride_period">
                <option value="morning">נסיעה יומית</option>
                <option value="night">נסיעה ליותר מיום</option>
              </select>
            </div>

            <div class="form-field-group" *ngIf="rideForm.get('ride_period')?.value === 'morning'">
              <label>תאריך הנסיעה</label>
              <input type="date" formControlName="ride_date" [min]="minDate" />
              <small *ngIf="f.ride_date.touched && f.ride_date.errors?.['required']" class="error-text">חובה למלא את
                שדה זה</small>
              <small *ngIf="f.ride_date.errors?.['tooSoon']" class="error-text">יש להזמין נסיעה לפחות יומיים
                מראש</small>
              <small *ngIf="f.ride_date.errors?.['invalidYear']" class="error-text">השנה צריכה להיות בין 2025
                ל-2099</small>
            </div>

            <div class="form-field-group">
              <label>סוג נסיעה</label>
              <select formControlName="ride_type" class="styled-select">
                <option value="" disabled>בחר סוג</option>
                <option value="administrative">מנהלתית</option>
                <option value="operational">מבצעית</option>
              </select>
              <small *ngIf="f.ride_type.touched && f.ride_type.errors?.['required']" class="error-text">חובה לבחור
                סוג נסיעה</small>
            </div>
          </div>

          <div class="form-row">
            <div class="form-field-group">
              <label>שעת התחלה</label>
              <div class="time-select-container">
                <ng-select [items]="hours" bindLabel="" formControlName="start_hour" placeholder="שעה"
                  class="time-select custom-hour-dropdown" [searchable]="false" [clearable]="false">
                </ng-select>
                <ng-select [items]="quarterHours" bindLabel="" formControlName="start_minute" placeholder="דקות"
                  class="time-select custom-hour-dropdown" [searchable]="false" [clearable]="false">
                </ng-select>
              </div>
              <small *ngIf="rideForm.errors?.['futureDateTime']" class="error-text">
                {{ rideForm.errors?.['futureDateTime']?.['message'] }}
              </small>
              <small
                *ngIf="rideForm.get('ride_period')?.value === 'morning' && f.start_time.touched && f.start_time.errors?.['required']"
                class="error-text">
                חובה למלא את שדה זה
              </small>
              <small *ngIf="f.start_time.touched && f.start_time.errors?.['invalidTimeStep']" class="error-text">
                נא לבחור זמן במרווחים של 15 דקות בלבד
              </small>
            </div>

            <div class="form-field-group">
              <label>שעת סיום</label>
              <div class="time-select-container">
                <ng-select [items]="hours" bindLabel="" formControlName="end_hour" placeholder="שעה"
                  class="time-select custom-hour-dropdown" [searchable]="false" [clearable]="false">
                </ng-select>
                <ng-select [items]="quarterHours" bindLabel="" formControlName="end_minute" placeholder="דקות"
                  class="time-select custom-hour-dropdown" [searchable]="false" [clearable]="false">
                </ng-select>
              </div>
              <small
                *ngIf="rideForm.get('ride_period')?.value === 'morning' && f.end_time.touched && f.end_time.errors?.['required']"
                class="error-text">
                חובה למלא את שדה זה
              </small>
              <small *ngIf="f.end_time.touched && f.end_time.errors?.['invalidTimeStep']" class="error-text">
                נא לבחור זמן במרווחים של 15 דקות בלבד
              </small>
            </div>
          </div>

          <div *ngIf="rideForm.get('ride_period')?.value === 'night'" class="form-row">
            <div class="form-field-group">
              <label>תאריך התחלה</label>
              <input type="date" formControlName="ride_date" [min]="minDate" />
            </div>
            <div class="form-field-group">
              <label>תאריך סיום</label>
              <input type="date" formControlName="ride_date_night_end" [min]="minDate" />
              <small *ngIf="rideForm.errors?.['sameDateNightRide']" class="error-text">
                  {{ rideForm.errors?.['sameDateNightRide']?.['message'] }}
              </small>
            </div>
          </div>

          <div class="form-field-group">
            <label>תחנה</label>
            <ng-select [items]="cities" bindLabel="name" bindValue="id" formControlName="stop" [searchable]="true"
              [clearable]="false" class="styled-select" placeholder="בחר עיר" notFoundText="לא נמצאו תחנות">
            </ng-select>
            <small *ngIf="f.stop.touched && f.stop.errors?.['required']" class="error-text">
              חובה למלא את שדה זה
            </small>
            <small class="distance-info">*נסיעתך תתחיל ותסתיים בבסיס הארגון: תל אביב</small>
          </div>

          <div id="extrastops" formArrayName="extraStops">
            <div *ngFor="let control of extraStops?.controls; let i = index" class="extra-stop-item">
              <button type="button" (click)="removeExtraStop(i)" class="removeBtn">❌</button>
              <div class="form-field-group">
                <label>תחנה נוספת {{ i + 1 }}</label>
                <ng-select [items]="cities" bindLabel="name" bindValue="id" [formControlName]="i" [searchable]="true"
                  [clearable]="false" class="styled-select" placeholder="בחר עיר">
                </ng-select>
                <small *ngIf="control.touched && control.errors?.['required']" class="error-text">
                  חובה למלא את שדה זה
                </small>
              </div>
            </div>

            <button type="button" (click)="addExtraStop()" [disabled]="extraStops.length >= 2" class="addBtn"
              *ngIf="extraStops">
              ➕ הוסף תחנה נוספת (אופציונלי)
            </button>
            <small *ngIf="extraStops.errors?.['consecutiveDuplicateStops']" class="error-text">
              תחנות עוקבות לא יכולות להיות זהות.
            </small>
            <small *ngIf="extraStops.errors?.['duplicateExtraStops']" class="error-text">
              תחנות עוקבות לא יכולות להיות זהות.
            </small>
          </div>

          <div class="form-row">
            <div class="form-field-group">
              <label>סוג רכב</label>
              <select formControlName="vehicle_type" class="styled-select" (change)="onRideTypeChange()">
                <option value="" disabled selected>בחר סוג</option>
                <option *ngFor="let type of vehicleTypes" [value]="type">{{ type }}</option>
              </select>

              <small *ngIf="f.vehicle_type.touched && f.vehicle_type.errors?.['required']" class="error-text">
                חובה למלא את שדה זה
              </small>

              <textarea formControlName="four_by_four_reason" placeholder="אנא פרט.י מדוע יש צורך בכרב 4X4"
                class="vehicle-type-info"
                *ngIf="f.vehicle_type.value?.toLowerCase().includes('jeep') || f.vehicle_type.value?.toLowerCase().includes('van') || f.vehicle_type.value?.toLowerCase().includes('4x4')"></textarea>

              <small
                *ngIf="(f.vehicle_type.value?.toLowerCase().includes('jeep') || f.vehicle_type.value?.toLowerCase().includes('van') || f.vehicle_type.value?.toLowerCase().includes('4x4')) && rideForm.get('four_by_four_reason')?.touched && rideForm.get('four_by_four_reason')?.errors?.['required']"
                class="error-text">
                חובה לפרט מדוע יש צורך ברכב זה
              </small>
            </div>

            <div class="form-field-group">
              <label *ngIf="!shouldShowCarError()">בחר רכב זמין</label>
              <select *ngIf="availableCars.length > 0" formControlName="car" class="styled-select">
                <option value="" disabled selected>בחר רכב</option>
                <option *ngFor="let car of availableCars" [value]="car.id" [disabled]="isPendingVehicle(car.id)"
                  [title]="isPendingVehicle(car.id) ? 'הרכב זה ממתין לעיבוד לתאריך/תקופה שנבחרו' : ''">
                  {{ car.vehicle_model }}
                </option>
              </select>

              <div
                *ngIf="rideForm?.get('vehicle_type') && (availableCars.length === 0 && hasTouchedVehicleType() &&shouldShowCarError()&&canChooseVehicle())"
                class="car-validation-message">
                <ng-container *ngIf="availableCars.length === 0 && !shouldShowCarError()">
                  אין רכבים זמינים מסוג זה בשעות שנבחרו,
                </ng-container>
                <ng-container *ngIf="availableCars.length === 0 && shouldShowCarError()">
                  אין רכבים זמינים מסוג זה בשעות שנבחרו. נא לבחור סוג רכב אחר.
                </ng-container>
                <ng-container *ngIf="availableCars.length > 0 && shouldShowCarError()">
                  {{ isPendingVehicle(f.car.value) ? 'רכב זה אינו זמין בשעות שנבחרו' : 'חובה לבחור רכב' }}
                </ng-container>
              </div>
            </div>
          </div>
        </div>





        <div class="button-container">
          <button type="submit" class="submit-btn" (click)="submit()">שלח</button>
        </div>
      </div>
    </form>







  </div>


  <div *ngIf="step === 2" class="full-trip-display">
    <h4>מסלול הנסיעה שלך:</h4>
    <hr>
    <a>תל אביב</a>
    <p>↓</p>
    <a>{{ getSelectedStopName() }}</a>
    <ng-container *ngFor="let extra of getExtraStopNames()">
      <p>↓</p>
      <a>{{ extra }}</a>
    </ng-container>
    <p>↓</p>
    <a>תל אביב</a>

    <div class="input-group">
      <label id="distance-title">הערכת מרחק (ק"מ)</label>

      <small *ngIf="f.estimated_distance_km.touched && f.estimated_distance_km.errors?.['required']"
        class="distance-info">
        חובה למלא את שדה זה
      </small>

      <small *ngIf="f.estimated_distance_km.errors?.['min']" class="distance-info">
        המרחק חייב להיות לפחות 1 ק״מ
      </small>

      <small class="distance-info" *ngIf="estimated_distance_with_buffer">
        המרחק לאחר תוספת סטייה: {{ estimated_distance_with_buffer }} ק"מ
      </small>

    </div>
  </div>

</div>