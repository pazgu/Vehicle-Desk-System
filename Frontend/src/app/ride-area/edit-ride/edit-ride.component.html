<div class="overlay">
  <div class="modal">
    <div class="headers">
          <h2>עריכת נסיעה</h2>
 <button class="back-btn" (click)="close()">חזור ←</button> 
 </div>
    <hr />
    

    <form [formGroup]="rideForm" (ngSubmit)="submit()">
      <div class="form-content">
        <!-- Row 1: סוג נסיעה + תאריך -->
        <div class="row">
          <div class="input-group">
            <label>סוג נסיעה</label>
            <select formControlName="ride_type" class="styled-select">
              <option value="administrative">מנהלתית</option>
              <option value="operational">מבצעית</option>
            </select>
          </div>

          <div class="input-group">
            <label>תאריך</label>
            <input type="date" formControlName="ride_date" [min]="minDate" />
          </div>
        </div>

       <div class="row" [formGroup]="rideForm">
  <div class="input-group">
    <label>שעת התחלה</label>
    <select formControlName="start_time">
      <option value="" disabled selected>בחר שעה</option>
      <option *ngFor="let time of timeOptions" [value]="time">
        {{ time }}
      </option>
    </select>
  </div>

  <div class="input-group">
    <label>שעת סיום</label>
    <select formControlName="end_time">
      <option value="" disabled selected>בחר שעה</option>
      <option *ngFor="let time of filteredEndTimes" [value]="time">
        {{ time }}
      </option>
    </select>
  </div>
</div>

        <!-- Row 3: סוג רכב + בחר רכב -->
        <div class="row">
          <div class="input-group">
            <label>סוג רכב</label>
            <select formControlName="vehicle_type" class="styled-select">
              <option >בחר סוג רכב</option>
            <option *ngFor="let type of vehicleTypes" [value]="type">{{ type }}</option>
            </select>
          </div>

          <div class="input-group">
            <label>בחר רכב</label>
            <select formControlName="car" class="styled-select">
              <option>בחר רכב</option>
<option *ngFor="let car of availableCars" [value]="car.id">{{ car.vehicle_model }}</option>
            </select>
          </div>
        </div>

        <!-- Row 4: מרחק -->
        <div class="row">
          <div class="input-group">
            <label>מרחק (ק"מ)</label>
            <input type="number" formControlName="estimated_distance_km" />
            <small *ngIf="rideForm.get('estimated_distance_km')?.value" class="distance-info">
              המרחק לאחר תוספת סטייה: {{ estimated_distance_with_buffer }} ק"מ
            </small>
          </div>
        </div>
<div class="form-field-group">
  <label>תחנה</label>
 

<select formControlName="stop" class="styled-select" required>
  <!-- All available cities - Angular will automatically select the one matching form value -->
  <option *ngFor="let city of cities" [value]="city.id">
    {{ city.name }}
  </option>
</select>
  <small *ngIf="rideForm.get('stop')?.touched && rideForm.get('stop')?.errors?.['required']" class="error-text">
    חובה למלא את שדה זה
  </small>
  <small class="distance-info">*נסיעתך תתחיל ותסתיים בבסיס הארגון: תל אביב</small>
</div>



  <!-- Extra stops FormArray -->
  <div id="extrastops" formArrayName="extraStops">
    <div *ngFor="let control of extraStops.controls; let i = index" [formGroupName]="i" class="extra-stop-item">
      <button type="button" (click)="removeExtraStop(i)" class="removeBtn">❌</button>
      <div class="form-field-group">
        <label>תחנה נוספת {{ i + 1 }}</label>
        <select formControlName="stop">
          <option value="">בחר עיר</option>
          <option *ngFor="let city of cities" [value]="city.id">{{ city.name }}</option>
        </select>
        <small *ngIf="control.get('stop')?.touched && control.get('stop')?.errors?.['required']" class="error-text">
          חובה למלא את שדה זה
        </small>
      </div>
    </div>

    <button type="button" (click)="addExtraStop()" [disabled]="extraStops.length >= 2" class="addBtn">
      ➕ הוסף תחנה נוספת (אופציונלי)
    </button>

    <small *ngIf="extraStops.errors?.['sameStopAsDestination']" class="error-text">
      תחנה נוספת לא יכולה להיות זהה לתחנה אחרת.
    </small>
    <small *ngIf="extraStops.errors?.['duplicateExtraStops']" class="error-text">
      תחנות נוספות לא יכולות להיות כפולות.
    </small>
  </div>
</div>
      <button class="submit-btn" type="submit">עדכן</button>
    </form>
  </div>
</div>
