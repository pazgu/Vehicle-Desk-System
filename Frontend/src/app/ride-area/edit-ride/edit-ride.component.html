<div class="overlay">
  <div class="modal">
    <div class="headers">
      <h2>עריכת נסיעה</h2>
      <button class="back-btn" (click)="close()">חזור ←</button>
    </div>
    <hr />

    <div class="ride-type-indicator" *ngIf="rideTypeNote">
      <div
        class="alert"
        [ngClass]="{ 'alert-info': isDayRide, 'alert-warning': !isDayRide }"
      >
        <i class="icon" [ngClass]="isDayRide ? 'pi pi-sun' : 'pi pi-moon'"></i>
        <span>{{ rideTypeNote }}</span>
      </div>
    </div>

    <form [formGroup]="rideForm" (ngSubmit)="submit()">
      <div class="form-content">
        <div class="row">
          <div class="input-group">
            <label>מספר ימי נסיעה</label>
            <select formControlName="ride_period" class="styled-select">
              <option value="morning">נסיעה יומית</option>
              <option value="night">נסיעה ליותר מיום</option>
            </select>
          </div>
          <div class="input-group">
            <label>סוג נסיעה</label>
            <select formControlName="ride_type" class="styled-select">
              <option value="">בחר סוג נסיעה</option>
              <option value="administrative">מנהלתית</option>
              <option value="operational">מבצעית</option>
            </select>
            <small class="error-text" *ngIf="getFieldError('ride_type')">
              {{ getFieldError("ride_type") }}
            </small>
          </div>
        </div>
        <div class="row" *ngIf="rideForm.get('ride_period')?.value === 'morning'">
          <div class="input-group">
            <label>תאריך הנסיעה</label>
            <input type="date" formControlName="ride_date" [min]="minDate" />
            <small class="error-text" *ngIf="getFieldError('ride_date')">
              {{ getFieldError("ride_date") }}
            </small>
          </div>
          <div class="input-group"></div>
        </div>
        <div class="row" *ngIf="rideForm.get('ride_period')?.value === 'night'">
          <div class="input-group">
            <label>תאריך התחלה</label>
            <input type="date" formControlName="ride_date" [min]="minDate" />
            <small class="error-text" *ngIf="getFieldError('ride_date')">
              {{ getFieldError("ride_date") }}
            </small>
          </div>
          <div class="input-group">
            <label>תאריך סיום</label>
            <input
              type="date"
              formControlName="ride_date_night_end"
              [min]="rideForm.get('ride_date')?.value"
            />
            <small class="error-text" *ngIf="getFieldError('ride_date_night_end')">
              חובה למלא תאריך סיום לנסיעה ליותר מיום
            </small>
            <small class="info-text">הנסיעה מסתיימת ביום אחר</small>
          </div>
        </div>

        <div class="row">
          <div class="input-group">
            <label>שעת התחלה</label>
            <select formControlName="start_time" class="styled-select">
              <option value="" disabled>בחר שעה</option>
              <option *ngFor="let time of timeOptions" [value]="time">
                {{ time }}
              </option>
            </select>
            <small class="error-text" *ngIf="getFieldError('start_time')">
              {{ getFieldError("start_time") }}
            </small>
          </div>

          <div class="input-group">
            <label>שעת סיום</label>
            <select formControlName="end_time" class="styled-select">
              <option value="" disabled>בחר שעה</option>
              <option *ngFor="let time of filteredEndTimes" [value]="time">
                {{ time }}
              </option>
            </select>
            <small class="error-text" *ngIf="getFieldError('end_time')">
              {{ getFieldError("end_time") }}
            </small>
            <small class="error-text" *ngIf="rideForm.errors?.['invalidTimeRange'] && isDayRide">
              {{ rideForm.errors?.['invalidTimeRange']?.['message'] }}
            </small>
            <small class="info-text" *ngIf="!isDayRide">
              לנסיעות יותר מיום ניתן לבחור כל שעה
            </small>
          </div>
        </div>
        <div class="time-fields-container">
          <div class="info-text-container" *ngIf="!rideForm.errors?.['futureDateTime'] && !rideForm.errors?.['inspectorClosureTime']">
            <small class="info-text">
              * לא ניתן להזמין נסיעות בשעות 11:15-12:15 (מנהל רכבים לא זמין)
            </small>
          </div>

          <div class="error-messages-container">
            <small
              *ngIf="rideForm.errors?.['futureDateTime']"
              class="error-text"
            >
              {{ rideForm.errors?.['futureDateTime']?.['message'] }}
            </small>
            <small
              *ngIf="rideForm.errors?.['inspectorClosureTime']"
              class="error-text"
            >
              {{ rideForm.errors?.['inspectorClosureTime']?.['message'] }}
            </small>
          </div>
        </div>
        <div class="form-field-group" *ngIf="isExtendedRequest">
          <label
            >סיבה לנסיעה ממושכת (4 ימים ומעלה)
            <span class="required">*</span></label
          >
          <textarea
            formControlName="extended_ride_reason"
            class="styled-textarea"
            rows="3"
            placeholder="נא לפרט את הסיבה לנסיעה ממושכת..."
            [class.error-border]="
              rideForm.get('extended_ride_reason')?.invalid &&
              rideForm.get('extended_ride_reason')?.touched
            "
          >
          </textarea>
          <small
            class="error-text"
            *ngIf="
              rideForm.get('extended_ride_reason')?.invalid &&
              rideForm.get('extended_ride_reason')?.touched
            "
          >
            חובה לפרט סיבה לנסיעה ממושכת
          </small>
          <small class="info-text">
            <i class="pi pi-info-circle"></i>
            נסיעות של 4 ימים ומעלה דורשות אישור מיוחד וסיבה מפורטת
          </small>
        </div>

        <div class="row">
          <div class="input-group">
            <label>סוג רכב</label>
            <select formControlName="vehicle_type" class="styled-select">
              <option value="">בחר סוג רכב</option>
              <option *ngFor="let type of vehicleTypes" [value]="type">
                {{ type }}
              </option>
            </select>
            <small class="error-text" *ngIf="getFieldError('vehicle_type')">
              {{ getFieldError("vehicle_type") }}
            </small>
          </div>

          <div class="input-group">
            <label>דגם רכב</label>
            <div class="custom-select">
              <div 
                *ngIf="availableCars.length > 0"
                class="select-header" 
                (click)="toggleDropdown()"
                [class.open]="isDropdownOpen"
              >
                <div class="selected-car" *ngIf="getSelectedCar(); else placeholder">
                  <img 
                    [src]="getSelectedCar().image_url" 
                    [alt]="getSelectedCar().vehicle_model"
                    class="car-thumbnail"
                  />
                  <div class="car-info">
                    <div class="car-model-wrapper">
                      <span class="car-model">{{ getSelectedCar().vehicle_model }}</span>
                      <span class="recommended-badge" *ngIf="getSelectedCar().is_recommended">מומלץ</span>
                    </div>
                    <span class="car-fuel-type">{{ getFuelTypeLabel(getSelectedCar().fuel_type) }}</span>
                  </div>
                </div>
                <ng-template #placeholder>
                  <span class="placeholder">בחר רכב</span>
                </ng-template>
                <div class="select-arrow">
                  <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                    <path d="M1 1.5L6 6.5L11 1.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
              </div>
              <div class="select-options" *ngIf="isDropdownOpen">
                <div 
                  *ngFor="let car of availableCars"
                  class="option"
                  [class.disabled]="isCarDisabled(car)"
                  [class.selected]="car.id === selectedCarId"
                  [class.recommended]="car.is_recommended"
                  (click)="selectCar(car.id)"
                  [title]="isCarDisabled(car) ? 'רכב לא זמין' : ''"
                >
                  <img 
                    [src]="car.image_url" 
                    [alt]="car.vehicle_model"
                    class="car-thumbnail"
                  />
                  <div class="car-info">
                    <div class="car-model-wrapper">
                      <span class="car-model">{{ car.vehicle_model }}</span>
                      <span class="recommended-badge" *ngIf="car.is_recommended">מומלץ</span>
                    </div>
                    <span class="car-fuel-type">{{ getFuelTypeLabel(car.fuel_type) }}</span>
                  </div>
                  <span *ngIf="isCarDisabled(car)" class="disabled-text"> - לא זמין</span>
                </div>
              </div>
            </div>
            <div class="dropdown-backdrop" *ngIf="isDropdownOpen" (click)="closeDropdown()"></div>
            
            <div
  class="no-vehicles-banner"
  *ngIf="
    rideForm.get('vehicle_type')?.value &&
    availableCars.length === 0
  "
>
  <i class="pi pi-exclamation-triangle icon"></i>
  <div class="text-wrapper">
    <div class="title">
      אין רכבים זמינים מסוג זה בשעות שנבחרו
    </div>
    <div class="subtitle">
      נא לבחור סוג רכב אחר או לעדכן את זמני הנסיעה
    </div>
  </div>
</div>

            <small
              class="error-text"
              *ngIf="rideForm.get('car')?.touched && rideForm.get('car')?.errors?.['required'] && availableCars.length > 0"
            >
              חובה לבחור רכב
            </small>
          </div>
        </div>

        <div
          class="form-field-group"
          *ngIf="
            rideForm.get('vehicle_type')?.value &&
            (rideForm
              .get('vehicle_type')
              ?.value.toLowerCase()
              .includes('4x4') ||
              rideForm
                .get('vehicle_type')
                ?.value.toLowerCase()
                .includes('jeep') ||
              rideForm.get('vehicle_type')?.value.toLowerCase().includes('van'))
          "
        >
          <label
            >סיבת שימוש ברכב {{ rideForm.get("vehicle_type")?.value }}
            <span class="required">*</span></label
          >
          <textarea
            formControlName="four_by_four_reason"
            class="styled-textarea"
            rows="3"
            placeholder="נא לפרט את הסיבה לשימוש ברכב מיוחד..."
            [class.error-border]="
              rideForm.get('four_by_four_reason')?.invalid &&
              rideForm.get('four_by_four_reason')?.touched
            "
          >
          </textarea>
          <small
            class="error-text"
            *ngIf="
              rideForm.get('four_by_four_reason')?.invalid &&
              rideForm.get('four_by_four_reason')?.touched
            "
          >
            חובה למלא סיבה לשימוש ברכב {{ rideForm.get("vehicle_type")?.value }}
          </small>
        </div>
        <div class="row">
          <div class="input-group">
            <label>מרחק (ק"מ)</label>

            <small
              *ngIf="rideForm.get('estimated_distance_km')?.value"
              class="distance-info"
            >
              המרחק לאחר תוספת סטייה: {{ estimated_distance_with_buffer }} ק"מ
            </small>
          </div>
          <div class="input-group"></div>
        </div>

        <div class="row">
          <div class="input-group">
            <label>נקודת התחלה</label>
            <input type="text" value="תל אביב" disabled />
          </div>

          <div class="input-group">
            <label>יעד סופי</label>
            <input type="text" value="תל אביב" disabled />
          </div>
        </div>

        <div class="form-field-group">
          <label>תחנה עיקרית</label>
          <select formControlName="stop" class="styled-select" required>
            <option value="">בחר תחנה</option>
            <option *ngFor="let city of cities" [value]="city.id">
              {{ city.name }}
            </option>
          </select>
          <small class="error-text" *ngIf="getFieldError('stop')">
            {{ getFieldError("stop") }}
          </small>
          <small class="distance-info"
            >*נסיעתך תתחיל ותסתיים בבסיס הארגון: תל אביב</small
          >
        </div>

        <div id="extrastops" formArrayName="extraStops">
          <div
            *ngFor="let control of extraStops.controls; let i = index"
            [formGroupName]="i"
            class="extra-stop-item"
          >
            <button
              type="button"
              (click)="removeExtraStop(i)"
              class="removeBtn"
            >
              <i class="pi pi-times"></i>
            </button>
            <div class="form-field-group">
              <label>תחנה נוספת {{ i + 1 }}</label>
              <select formControlName="stop" class="styled-select">
                <option value="">בחר עיר</option>
                <option *ngFor="let city of cities" [value]="city.id">
                  {{ city.name }}
                </option>
              </select>
              <small
                *ngIf="control.get('stop')?.touched && control.get('stop')?.errors?.['required']"
                class="error-text"
              >
                חובה למלא את שדה זה
              </small>
            </div>
          </div>

          <button
            type="button"
            (click)="addExtraStop()"
            [disabled]="extraStops.length >= 2"
            [class.disabled-button]="extraStops.length >= 2"
            class="addBtn"
          >
            <i
              [class.pi-plus]="extraStops.length < 2"
              [class.pi-ban]="extraStops.length >= 2"
              class="pi"
            ></i>
            {{
              extraStops.length >= 2
                ? "הגעת למקסימום תחנות"
                : "הוסף עוד תחנה (אופציונלי - מקסימום 2)"
            }}
          </button>

          <small
            *ngIf="extraStops.errors?.['sameStopAsDestination']"
            class="error-text"
          >
            תחנה נוספת לא יכולה להיות זהה לתחנה העיקרית
          </small>
          <small
            *ngIf="extraStops.errors?.['duplicateExtraStops']"
            class="error-text"
          >
            תחנות נוספות לא יכולות להיות כפולות
          </small>
        </div>
      </div>
      <button class="submit-btn" type="submit">עדכן</button>
    </form>
  </div>
</div>
