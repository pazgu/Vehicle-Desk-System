<div class="overlay">
  <div class="modal">
    <div class="headers">
      <h2>עריכת נסיעה</h2>
      <button class="back-btn" (click)="close()">חזור ←</button>
    </div>
    <hr />

    <div class="ride-type-indicator" *ngIf="rideTypeNote">
      <div class="alert" [ngClass]="{'alert-info': isDayRide, 'alert-warning': !isDayRide}">
        <span class="icon">{{ isDayRide ? '☀️' : '🌙' }}</span>
        <span>{{ rideTypeNote }}</span>
      </div>
    </div>

    <form [formGroup]="rideForm" (ngSubmit)="submit()">
      <div class="form-content">
        <div class="row">
          <div class="input-group">
            <label>סוג נסיעה</label>
            <select formControlName="ride_type" class="styled-select">
              <option value="">בחר סוג נסיעה</option>
              <option value="administrative">מנהלתית</option>
              <option value="operational">מבצעית</option>
            </select>
            <small class="error-text" *ngIf="getFieldError('ride_type')">
              {{ getFieldError('ride_type') }}
            </small>
          </div>

          <div class="input-group">
            <label>תאריך התחלה</label>
            <input type="date" formControlName="ride_date" [min]="minDate" />
            <small class="error-text" *ngIf="getFieldError('ride_date')">
              {{ getFieldError('ride_date') }}
            </small>
          </div>
        </div>

        <div class="row" *ngIf="!isDayRide">
          <div class="input-group">
            <label>תאריך סיום (נסיעה ליותר מיום)</label>
            <input type="date" formControlName="ride_date_night_end"
                   [min]="rideForm.get('ride_date')?.value" />
            <small class="info-text">הנסיעה מסתיימת ביום אחר</small>
          </div>
          <div class="input-group"></div> </div>

        <div class="row">
          <div class="input-group">
            <label>שעת התחלה</label>
            <select formControlName="start_time" class="styled-select">
              <option value="" disabled>בחר שעה</option>
              <option *ngFor="let time of timeOptions" [value]="time">
                {{ time }}
              </option>
            </select>
            <small class="error-text" *ngIf="getFieldError('start_time')">
              {{ getFieldError('start_time') }}
            </small>
          </div>

          <div class="input-group">
            <label>שעת סיום</label>
            <select formControlName="end_time" class="styled-select">
              <option value="" disabled>בחר שעה</option>
              <option *ngFor="let time of filteredEndTimes" [value]="time">
                {{ time }}
              </option>
            </select>
            <small class="error-text" *ngIf="getFieldError('end_time')">
              {{ getFieldError('end_time') }}
            </small>
            <small class="error-text" *ngIf="hasTimeRangeError() && isDayRide">
              שעת הסיום חייבת להיות לפחות 15 דקות אחרי שעת ההתחלה
            </small>
            <small class="info-text" *ngIf="!isDayRide">
              לנסיעות יותר מיום ניתן לבחור כל שעה
            </small>
          </div>
        </div>

        <div class="row">
          <div class="input-group">
            <label>סוג רכב</label>
            <select formControlName="vehicle_type" class="styled-select">
              <option value="">בחר סוג רכב</option>
              <option *ngFor="let type of vehicleTypes" [value]="type">{{ type }}</option>
            </select>
            <small class="error-text" *ngIf="getFieldError('vehicle_type')">
              {{ getFieldError('vehicle_type') }}
            </small>
          </div>

          <div class="input-group">
            <label>בחר רכב</label>
            <select formControlName="car" class="styled-select">
              <option value="">בחר רכב</option>
              <option *ngFor="let car of availableCars"
                      [value]="car.id"
                      [disabled]="isCarDisabled(car)">
                {{ car.vehicle_model }}
                <span *ngIf="isCarDisabled(car)"> - לא זמין</span>
              </option>
            </select>
            <small class="info-text" *ngIf="rideForm.get('vehicle_type')?.value && availableCars.length === 0">
              אין רכבים זמינים מסוג זה לתאריך ושעות שנבחרו
            </small>
            <small class="error-text" *ngIf="getFieldError('car')">
              {{ getFieldError('car') }}
            </small>
          </div>
        </div>

        <div class="row">
          <div class="input-group">
            <label>מרחק (ק"מ)</label>
           
            <small *ngIf="rideForm.get('estimated_distance_km')?.value" class="distance-info">
              המרחק לאחר תוספת סטייה: {{ estimated_distance_with_buffer }} ק"מ
            </small>
          </div>
          <div class="input-group"></div> </div>

       <div class="row">
  <div class="input-group">
    <label>נקודת התחלה</label>
    <input type="text" value="תל אביב" disabled />
  </div>

  <div class="input-group">
    <label>יעד סופי</label>
    <input type="text" value="תל אביב" disabled />
  </div>
</div>


        <div class="form-field-group">
          <label>תחנה עיקרית</label>
          <select formControlName="stop" class="styled-select" required>
            <option value="">בחר תחנה</option>
            <option *ngFor="let city of cities" [value]="city.id">
              {{ city.name }}
            </option>
          </select>
          <small class="error-text" *ngIf="getFieldError('stop')">
            {{ getFieldError('stop') }}
          </small>
          <small class="distance-info">*נסיעתך תתחיל ותסתיים בבסיס הארגון: תל אביב</small>
        </div>

        <div id="extrastops" formArrayName="extraStops">
          <div *ngFor="let control of extraStops.controls; let i = index"
               [formGroupName]="i"
               class="extra-stop-item">
            <button type="button" (click)="removeExtraStop(i)" class="removeBtn">❌</button>
            <div class="form-field-group">
              <label>תחנה נוספת {{ i + 1 }}</label>
              <select formControlName="stop" class="styled-select">
                <option value="">בחר עיר</option>
                <option *ngFor="let city of cities" [value]="city.id">{{ city.name }}</option>
              </select>
              <small *ngIf="control.get('stop')?.touched && control.get('stop')?.errors?.['required']"
                     class="error-text">
                חובה למלא את שדה זה
              </small>
            </div>
          </div>

          <button type="button"
                  (click)="addExtraStop()"
                  [disabled]="extraStops.length >= 2"
                  class="addBtn">
            ➕ הוסף תחנה נוספת (אופציונלי - מקסימום 2)
          </button>

          <small *ngIf="extraStops.errors?.['sameStopAsDestination']" class="error-text">
            תחנה נוספת לא יכולה להיות זהה לתחנה העיקרית
          </small>
          <small *ngIf="extraStops.errors?.['duplicateExtraStops']" class="error-text">
            תחנות נוספות לא יכולות להיות כפולות
          </small>
        </div>
      </div>
         <button class="submit-btn" type="submit">עדכן</button>
      </form>
  </div>
</div>
